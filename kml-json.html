<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-toast/paper-toast.html">

<link rel="import" href="kml-json-api.html">

<!--
`kml-json`
convert kml to geojson. 

@demo demo/index.html 
-->

<dom-module id="kml-json">
    <template>
      <style>
        :host {
          display: block;
        }
        .yellow-button {
            text-transform: none;
            color: #eeff41;
        }
      </style>
      
      <iron-ajax 
        auto
        url="[[url]]"
        params="[[_params]]"
        handle-as="text"
        loading="{{loading}}"
        last-response="{{response}}"
        debounce-duration="300">
      </iron-ajax>

      <paper-toast id="toast" text="[[toastmsg]]" duration="[[duration]]">
         <paper-button onclick="toast.toggle()" class="yellow-button">Close !</paper-button>
      </paper-toast>

    </template>

    <script>
        Polymer({

            is: 'kml-json',

            properties: {
                /**
                 * 
                 */
                url: {
                    type: String // ,  value: ''
                },

                /**
                 * 
                 */
                _params: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },

                /**
                 * 
                 */
                service: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },

                query: {
                    tape: String,
                    value: {}
                },

                // ajax status-flag
                loading: {
                    type: Boolean
                },

                toastmsg: {
                    type: String
                },

                /**
                 * 
                 */
                response: {
                    type: String,
                    value: ""
                },

                /**
                 * 
                 */
                geojson: {
                    type: Object,
                    notify: true
                },

            },

            observers: [
                'makeGeojson(response, query, loading)',
                'ajaxparams(service.*, url)',
                'logAction(geojson.*)'
            ],

            /**
             * 
             */
            ajaxparams: function(service, url) {
                // console.log("make params from service", service.value);
                this._params = service.value; // console.log(this._params);
            },


            /**
             * kml : response from observer
             * query : optional query to apply on kml-response
             * loading : 
             */
            makeGeojson: function(response, query, loading) {
                if (loading) return;  
                // console.log("RAW RESPONSE to " + this.url, typeof response, loading, query, response);
                if (!response ) {
                    this.toastMsg("No response from "+ this.url);
                    return;
                }    

                var tags, structure;
                if (query) {
                    tags = query.tags;
                    structure = query.structure;
                }

                // 1. Convert string to DOM
                var kml = (new DOMParser()).parseFromString(response, 'text/xml');
                if (!kml) return json;

                // 2. Use plugin to convert kml-DOM into geojson
                var json = {};
                if (kml.documentElement.tagName == "kml") {

                    this.toastMsg("data converted from KML");

                    json = toGeoJSON.kml(kml, tags);
                    // console.log("kml:", kml, json);
                    if (json.features) {
                        json.dom = kml;
                        json.time = Date.now();
                    }

                } else if (kml.documentElement.tagName == "gpx") {

                    this.toastMsg("data converted from GPX");

                    json = toGeoJSON.gpx(kml, tags);
                    if (json.features) {
                        json.dom = kml;
                        json.time = Date.now();
                    }

                } else if (kml.documentElement.tagName == "html") {

                    this.toastMsg(response); 
                    return; 

                } else {

                    this.toastMsg(response); 
                    return;
                }

                if (!json.features) {
                    this.toastMsg("NO features in response!"); 
                    return;
                }

                // (Specific) output structures. 
                if (structure == "doc") {
                    if (json.dom) delete json.dom;
                    this.geojson = json;
                    return;
                }
                
                this.geojson = json.features;

                this.kml = null; // reset ???  
            },

            /**
             * 
             */
            logAction: function(json) {
                if (!json || !Object.keys(json).length) return;
                var geojson = json.value;
                // console.log("LOG: url=" + this.url, "with", this.params, "output:", geojson);
            },

            /**
             * 
             */
            toastMsg: function(txt) {
                if (txt) {
                    this.toastmsg = txt; 
                    if (txt.length > 50) this.duration = 0;
                    this.$.toast.open();                    
                    console.log("kml-json", txt); // , url)
                }
                this.duration = 3000;
            }

        });
    </script>
</dom-module>