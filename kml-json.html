<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-toast/paper-toast.html">

<link rel="import" href="kml-json-api.html">

<!--
`kml-json`
convert kml to geojson. 

@demo demo/index.html 
-->

<dom-module id="kml-json">
    <template>
      <style>
        :host {
          display: block;
        }
        .yellow-button {
            text-transform: none;
            color: #eeff41;
        }
      </style>
      
      <iron-ajax 
        auto
        url="[[url]]"
        params="[[_params]]"
        handle-as="text"
        loading="{{loading}}"
        last-response="{{response}}"
        debounce-duration="300">
      </iron-ajax>

      <paper-toast id="toast" text="[[toastmsg]]" duration="[[duration]]">
         <paper-button onclick="toast.toggle()" class="yellow-button">Close !</paper-button>
      </paper-toast>

    </template>

    <script>
        Polymer({

            is: 'kml-json',

            properties: {
                /**
                 * 
                 */
                url: {
                    type: String // ,  value: ''
                },

                /**
                 * 
                 */
                _params: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },

                /**
                 * 
                 */
                service: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },

                query: {
                    tape: String,
                    value: {}
                },

                // ajax status-flag
                loading: {
                    type: Boolean
                },

                toastmsg: {
                    type: String
                },

                /**
                 * 
                 */
                response: {
                    type: String,
                    value: ""
                },

                /**
                 * 
                 */
                geojson: {
                    type: Object,
                    notify: true
                },

            },

            observers: [
                'makeGeojson(response, query, loading)',
                'ajaxparams(service.*, url)',
                'logAction(geojson.*)'
            ],

            /**
             * 
             */
            ajaxparams: function(service, url) {
                // console.log("make params from service", service.value);
                this._params = service.value; // console.log(this._params);
            },


            /**
             * response : response from observer
             * query : optional query to apply on raw response
             * loading : server-action-flag
             */
            makeGeojson: function(response, query, loading) {
                if (loading) return;  
                if (!query) query = {}; // some preliminary filtering and/or formatting 

                // console.log("RAW RESPONSE to " + this.url, typeof response, loading, query, response);
                this.debounce("make", function() {
                    
                    if (!response ) {
                        this.toastMsg("No response from "+ this.url);
                        return;
                    }    

                    // 1. Convert string to DOM
                    var kml = (new DOMParser()).parseFromString(response, 'text/xml');
                    if (!kml) return json;

                    // 2. Use plugin to convert kml-DOM into geojson
                    var json = {};
                    if (kml.documentElement.tagName == "kml") {

                        this.toastMsg("data converted from KML");

                        json = toGeoJSON.kml(kml, query.tags);
                        // console.log("kml:", kml, json);
                        if (json.features) {
                            json.dom = kml;
                            json.time = Date.now();
                        }

                    } else if (kml.documentElement.tagName == "gpx") {

                        this.toastMsg("data converted from GPX");

                        json = toGeoJSON.gpx(kml, query.tags);
                        if (json.features) {
                            json.dom = kml;
                            json.time = Date.now();
                        }

                    } else if (kml.documentElement.tagName == "html") {

                        this.toastMsg(response); 
                        return; 

                    } else {

                        this.toastMsg(response); 
                        return;
                    }

                    if (!json.features) {
                        this.toastMsg("NO features in response!"); 
                        return;
                    }   // console.log("JSON-RAW", json); 

                    if (query.time || query.start || query.stop) {
                        var nall = json.features.length, 
                            ff = [],
                            t, flag;
                        json.features.forEach(function(f){

                            flag = true; 
                            t = f.properties.time;
                            if (t) { 
                                if (query.start &&  (t < query.start)) flag = false;
                                if (query.stop &&  (t > query.stop)) flag = false
                                if (query.time && (t.indexOf(query.time) < 0)) flag = false;
                            }

                            if (flag)  ff.push(f);

                        });
                        json.features = ff; 
                        console.log(ff.length + "/" + nall +" queried by ", query, json); 
                    }     

                    if (!json.features.length) return; 

                    json.time = Date.now();
                    
                    // (Specific) output structures. 
                    if (query.structure == "doc") {
                        this.geojson = json;
                        return;
                    } 
                    if (query.structure == "dom") {
                        json.dom = kml;
                        this.geojson = json;
                        return;
                    } 

                    this.geojson = json.features;

                    this.kml = null; // reset ???  

                },1000);
            },

            /**
             * 
             */
            logAction: function(json) {
                if (!json || !Object.keys(json).length) return;
                var geojson = json.value;
                // console.log("LOG: url=" + this.url, "with", this.params, "output:", geojson);
            },

            /**
             * 
             */
            toastMsg: function(txt) {
                if (txt) {
                    this.toastmsg = txt; 
                    if (txt.length > 50) this.duration = 0;
                    this.$.toast.open();                    
                    console.log("kml-json", txt); // , url)
                }
                this.duration = 3000;
            }

        });
    </script>
</dom-module>