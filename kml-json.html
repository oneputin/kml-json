<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="kml-json-api.html">

<!--
`kml-json`
convert kml to geojson. 

@demo demo/index.html 
-->

<dom-module id="kml-json">
    <template>
      <style>
        :host {
          display: block;
        }
      </style>
      
      <iron-ajax 
        auto
        url="[[url]]"
        params="[[_params]]"
        handle-as="text"
        last-response="{{kml}}"
        debounce-duration="300">
      </iron-ajax>

    </template>

    <script>
        Polymer({

            is: 'kml-json',

            properties: {
                /**
                 * 
                 */
                url: {
                    type: String,
                    value: ''
                },


                /**
                 * 
                 */
                _params: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },

                /**
                 * 
                 */
                service: {
                    type: Object,
                    value: function() {
                        return {};
                    }
                },

                query: {
                    tape: String,
                    value: {}
                },


                /**
                 * 
                 */
                kml: {
                    type: String,
                    value: ""
                },

                /**
                 * 
                 */
                geojson: {
                    type: Object,
                    notify: true
                },

            },

            observers: [
                'makeGeojson(kml, query)', // , url)',
                'ajaxparams(service.*, url)',
                'logAction(geojson.*)'
            ],

            /**
             * 
             */
            ajaxparams: function(service, url) {
                // console.log("make params from service", service.value);
                this._params = service.value; // console.log(this._params);
            },

            /**
             * 
             */
            makeGeojson: function(kml, query) {
                let json = {};
                if (!kml || !Object.keys(kml).length) return json;
                if (query) {
                    tags = query.tags;
                }

                // 1. Convert string to DOM
                // 2. Use plugin to convert kml-DOM into geojson
                kml = (new DOMParser()).parseFromString(kml, 'text/xml');
                if (!kml) return json;
                // console.log(kml.documentElement.tagName, url);

                if (kml.documentElement.tagName == "kml") {
                    console.log("kml:", kml);
                    json = toGeoJSON.kml(kml, tags);
                    if (json.features) {
                        json.dom = kml;
                        json.time = Date.now();
                    }

                } else if (kml.documentElement.tagName == "gpx") {
                    console.log("gpx:", query, kml);
                    json = toGeoJSON.gpx(kml, tags);
                    if (json.features) {
                        json.dom = kml;
                        json.time = Date.now();
                    }
                } else if (kml.documentElement.tagName == "html") {
                    var error = kml.querySelector("parseerror");
                    console.log("error", error); // , url)
                    json = {};
                } else {
                    console.log("??Unknown Format??:", kml.documentElement.tagName, kml);
                    return;
                }

                console.log("GEOJSON:", json);
                this.geojson = json;
                // return json;
            },

            /**
             * 
             */
            logAction: function(json) {
                if (!json || !Object.keys(json).length) return;
                var geojson = json.value;
                // console.log("LOG: url=" + this.url, "with", this.params, "output:", geojson);
            }

        });
    </script>
</dom-module>